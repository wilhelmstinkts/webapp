<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/form.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source%20Sans%20Pro">

  <meta name="theme-color" content="#fafafa">
  <script type="text/javascript" src="js/services/locationService.js"></script>
  <script type="text/javascript" src="js/services/reportService.js"></script>
  <script type="text/javascript" src="environment.js"></script>
  <script type="text/javascript" src="js/exceptions/addressNotFoundException.js"></script>
</head>

<body>
  <!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <form id="form" autocomplete="on" onsubmit="return false">
    <h3>Deine Kontaktdaten</h3>
    <div class="formRow">
      <input type="text" style="flex:1;" id="inputGivenName" name="fname" placeholder="Vorname" required=true
        minlength="2" autocomplete="given-name" />
      <input type="text" style="flex:2;" id="inputSurname" name="lname" placeholder="Nachname" required=true
        minlength="2" autocomplete="family-name" />
    </div>
    <div class="formRow">
      <input type="email" id="inputEmail" style="width: 100%;" name="email" placeholder="E-Mailadresse" required=true
        minlength="2" autocomplete="email" />
    </div>
    <h3>Ort des Gestanks</h3>
    <button id="buttonPositiontoggle" name="notAdress" type="button" onclick="getLocation()">Meine Position
      verwenden</button>
    <div class="formRow">
      <input type="text" id="inputStreet" style="flex:3;" name="street" placeholder="Straße" required=true
        minlength="2" />
      <input type="text" id="inputNumber" style="flex:1;" name="number" placeholder="Hausnummer" required=true />
    </div>
    <p id="positionDisplay" hidden></p>
    <h3>Beschreibung des Gestanks</h3>
    <div class="formRow">
      <div style="flex: 1; display: flex; flex-direction: column;">
        <select onchange="showDiverse()" id="selectFlavor" name="kind" placeholder="Wonach riecht es?" required>
          <option value="" disabled selected hidden>Wonach riecht es?</option>
          <option>Biomüll</option>
          <option>Lack</option>
          <option>Kaffee</option>
          <option>Schokolade</option>
          <option>Bäckerei</option>
          <option>Sonstiges</option>
        </select>
        <input type="text" id="inputDiverse" placeholder="Bitte Geruch beschreiben" hidden />
      </div>
      <div class="intensityWrapper">
        <div>
          <label for="intensity">Intensität</label>
        </div>
        <div>
          <input id="inputStinkIntensity" type="range" min="1" max="5" name="intensity">
        </div>
        <div class="intensityLabels">
          <div>Dezent</div>
          <div>Sehr stark</div>
        </div>
      </div>
    </div>
    <hr />
    <div class="formRow">
      <input type="checkbox" style="flex: 1;" name="checkConsent" required=true> <label style="flex: 20;"
        for="checkConsent"> Ich bin damit einverstanden,
        dass meine eingegebenen Daten an die Senatsverwaltung für Umwelt, Verkehr und Klimaschutz gesendet werden sowie
        meine Eingaben anonymisiert von dieser Website gespeichert werden.</label>
    </div>
    <button type="submit" onclick="sendForm()">Senden</button>
    <p id="submitStatus" hidden></p>
  </form>

</body>
<script>
  async function sendForm() {
    var form = document.getElementById("form");
    var submitStatus = document.getElementById("submitStatus");
    submitStatus.removeAttribute("hidden", "");
    var statusMessage = "";

    if (form.checkValidity()) {
      try {
        let address;
        if (coordinates === undefined) {
          address = {
            country: "Germany",
            city: "Berlin",
            zip: "13158",
            street: document.getElementById("inputStreet").value,
            number: document.getElementById("inputNumber").value
          };
          coordinates = await LocationService.getCoordinatesForAddress(address);
        }

        else if (address === undefined) {
          address = await LocationService.getAddressForCoordinates(coordinates);
        }

        const reportToSend = {
          time: new Date().toISOString(),
          location: {
            address: address,
            coordinates: coordinates
          },
          stink: {
            kind: document.getElementById("selectFlavor").value === "Sonstiges" ? document.getElementById("inputDiverse").value : document.getElementById("selectFlavor").value,
            intensity: document.getElementById("inputStinkIntensity").value
          },
          reporter: {
            name: `${document.getElementById("inputGivenName").value} ${document.getElementById("inputSurname").value}`,
            email: document.getElementById("inputEmail").value
          }
        };
        if (!Environment.isTest() && ReportService.postReport(reportToSend) === true) {
          statusMessage = "Danke für deine Meldung!";
        }
        else {
          statusMessage = "Server nicht erreichbar. Bitte versuch es später noch einmal.";
        }
      }
      catch (error) {
        if (error instanceof AddressNotFoundException) {
          statusMessage = "Wir konnten diese Adresse nicht in Wilhelmsruh finden. Bitte prüfe deine Eingabe oder nutze die Standortbestimmung.";
        }
        else {
          statusMessage = `Unerwarteter Fehler: ${error}`;
        }
      }
    }
    else {
      statusMessage = "Bitte prüfe deine Angaben.";
    }
    submitStatus.innerText = statusMessage;
  }

  var positionDisplay = document.getElementById("positionDisplay");
  let coordinates;

  function getLocation() {
    positionDisplay.removeAttribute("hidden", "");
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(saveAndshowPosition, showCoordinateError);
    } else {
      positionDisplay.innerHTML = "Dein Browser unterstützt keine Ortung.";
    }
  }

  function showCoordinateError() {
    positionDisplay.innerHTML = "Ortung nicht erfolgreich. Bitte räume dieser Seite Zugriff auf deinen Standort ein oder nutze die Standortangabe als Adresse.";
  }

  function saveAndshowPosition(position) {
    if (position.coords) {
      coordinates = position.coords;
      positionDisplay.innerHTML = "Deine Position: <br />"
        + position.coords.latitude.toLocaleString('de-DE', { maximumFractionDigits: 5 }) + "° Breite <br />"
        + position.coords.longitude.toLocaleString('de-DE', { maximumFractionDigits: 5 }) + "° Länge";
      document.getElementById("inputStreet").setAttribute("hidden", "true");
      document.getElementById("inputNumber").setAttribute("hidden", "true");
      document.getElementById("inputStreet").removeAttribute("required", "");
      document.getElementById("inputNumber").removeAttribute("required", "");
      var toggleButton = document.getElementById("buttonPositiontoggle");
      toggleButton.innerText = "Adresse eingeben";
      toggleButton.onclick = showAdress;
    }
  }

  function showAdress() {
    positionDisplay.setAttribute("hidden", true);
    document.getElementById("inputStreet").removeAttribute("hidden", "");
    document.getElementById("inputNumber").removeAttribute("hidden", "");
    document.getElementById("inputStreet").setAttribute("required", "");
    document.getElementById("inputNumber").setAttribute("required", "");
    var toggleButton = document.getElementById("buttonPositiontoggle");
    toggleButton.innerText = "Meine Position verwenden";
    toggleButton.onclick = getLocation;
  }

  function showDiverse() {
    var inputDiverse = document.getElementById("inputDiverse");
    var selection = document.getElementById("selectFlavor").value;
    if (selection == "Sonstiges") {
      inputDiverse.removeAttribute("hidden");
      inputDiverse.setAttribute("required", "");
    }
    else {
      inputDiverse.removeAttribute("required");
      inputDiverse.setAttribute("hidden", "");
    }

  }
</script>


</html>